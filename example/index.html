
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://caveconnectome.github.io/CAVEnvq/example/">
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../reference/reference/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.33">
    
    
      
        <title>Example - CAVE-nvq</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Bitter:300,300i,400,400i,700,700i%7CInconsolata:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Bitter";--md-code-font:"Inconsolata"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#example" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="CAVE-nvq" class="md-header__button md-logo" aria-label="CAVE-nvq" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CAVE-nvq
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Example
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/CAVEconnectome/CAVEnvq/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    CAVEconnectome/CAVEnvq
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
    
  
  About

      </a>
    </li>
  

      
        
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
    
  
  Example

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../reference/reference/" class="md-tabs__link">
          
  
    
  
  Function Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="CAVE-nvq" class="md-nav__button md-logo" aria-label="CAVE-nvq" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    CAVE-nvq
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/CAVEconnectome/CAVEnvq/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    CAVEconnectome/CAVEnvq
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Example
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Example
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#initialize-cave-tables-and-neuvue-namespaces" class="md-nav__link">
    <span class="md-ellipsis">
      Initialize CAVE tables and Neuvue namespaces
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#get-a-collection-of-synapses-and-build-up-neuroglancer-states" class="md-nav__link">
    <span class="md-ellipsis">
      Get a collection of synapses and build up neuroglancer states
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-and-submit-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      Create and submit tasks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#checking-the-queue" class="md-nav__link">
    <span class="md-ellipsis">
      Checking the queue
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../reference/reference/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Function Reference
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="example">Example</h1>
<p>In this example, we will create a set of proofreading tasks where we ask proofreaders to assign the category of the postsynaptic targets of a particular neuron.
Note that this assumes you are already familiar with and authenticated into CAVEclient and Neuvue.</p>
<p>First, we need to decide on a neuron and the categories we want to use.
Here, will will use pick an inhibitory neuron and the categories will be "excitatory", "inhibitory", "unsure", and "error."</p>
<h4 id="initialize-cave-tables-and-neuvue-namespaces">Initialize CAVE tables and Neuvue namespaces</h4>
<p>You will only need to do this once for each table you want to use for tracking proofreading, but it should be done first.</p>
<p>For the CAVE tables, we can use the <code>cavenvq.create_task_tables</code> function to create the necessary task tables.
We will use the default schema, since they offer everything we need.
In addition, because we want to create new annotations from the work done by proofreaders, we also need to define a "broadcast" table where these can live.
Here, will make these a new table called <code>test_synapse_target_broadcast</code> and set up with a "bound tag" that will just have a single string value.
Scientifically, a reference annotation would make more sense but here we want to use the point annotations.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">cavenvq</span>
<span class="kn">from</span> <span class="nn">neuvueclient</span> <span class="kn">import</span> <span class="n">NeuvueQueue</span>
<span class="kn">from</span> <span class="nn">caveclient</span> <span class="kn">import</span> <span class="n">CAVEclient</span>

<span class="n">datastack</span> <span class="o">=</span> <span class="s1">&#39;minnie65_phase3_v1&#39;</span>
<span class="n">caveclient</span> <span class="o">=</span> <span class="n">CAVEclient</span><span class="p">(</span><span class="n">datastack</span><span class="p">)</span>

<span class="c1"># Set up CAVE task table</span>
<span class="n">task_table</span> <span class="o">=</span> <span class="s2">&quot;test_synapse_target_proofreading&quot;</span>
<span class="n">cavenvq</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">create_task_tables</span><span class="p">(</span>
    <span class="n">table_name</span> <span class="o">=</span> <span class="n">task_table</span><span class="p">,</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Table to test cavenvq for tracking proofreading of synapse targets. By Casey Schneider-Mizell&quot;</span><span class="p">,</span>
    <span class="n">voxel_resolution</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">40</span><span class="p">],</span>
    <span class="n">cv_client</span> <span class="o">=</span> <span class="n">caveclient</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Set up the broadcast table for annotations created during proofreading.</span>
<span class="c1"># This will be a standard table, so set it up as usual for CAVE.</span>
<span class="n">broadcast_table</span> <span class="o">=</span> <span class="s2">&quot;test_synapse_target_broadcast&quot;</span>


<span class="c1"># Set up Neuvue namespace</span>
<span class="n">nv_namespace</span> <span class="o">=</span> <span class="s1">&#39;cavenvq_test&#39;</span>
</code></pre></div>
<p>For Neuvue, we will need to create a namespace for the proofreading tasks.
This is done by going to the <a href="https://app.neuvue.io">Neuvue web interface</a>, going to <em>Admin Tools</em>&gt;<em>Console</em> and then clicking on <em>Namespaces</em>.
From there, click "ADD NAMESPACE" in the upper right and set up the namespace you want to use.
For this example, our namespace will be <code>cavenvq_test</code>.</p>
<h4 id="get-a-collection-of-synapses-and-build-up-neuroglancer-states">Get a collection of synapses and build up neuroglancer states</h4>
<p>We will get a list of inhibitory neurons and then build up a neuroglancer state for a random sample of synapses from each one and add a particular set of tags that we will want proofreaders to use.
This is just CAVE client stuff.
Note that the links we want are directly to the JSON, and do not include the neuroglancer viewer URL.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">nglui</span> <span class="kn">import</span> <span class="n">statebuilder</span>

<span class="n">cell_df</span> <span class="o">=</span> <span class="n">caveclient</span><span class="o">.</span><span class="n">materialize</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">allen_column_mtypes_v2</span><span class="p">(</span><span class="n">classification_system</span><span class="o">=</span><span class="s1">&#39;inhibitory&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">()</span>

<span class="c1"># Get three random cells with cell type labeled &quot;DTC&quot;</span>
<span class="n">root_ids</span> <span class="o">=</span> <span class="n">cell_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;cell_type==&quot;DTC&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">3</span><span class="p">)[</span><span class="s1">&#39;pt_root_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Make a statebuilder for each synapse state we will give to proofreaders</span>
<span class="n">TAGS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;excitatory&#39;</span><span class="p">,</span> <span class="s1">&#39;inhibitory&#39;</span><span class="p">,</span> <span class="s1">&#39;unsure&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">]</span>
<span class="n">img</span><span class="p">,</span> <span class="n">seg</span> <span class="o">=</span> <span class="n">statebuilder</span><span class="o">.</span><span class="n">from_client</span><span class="p">(</span><span class="n">caveclient</span><span class="p">)</span>
<span class="n">seg</span><span class="o">.</span><span class="n">add_selection_map</span><span class="p">(</span><span class="n">selected_ids_column</span><span class="o">=</span><span class="s1">&#39;pre_pt_root_id&#39;</span><span class="p">)</span>

<span class="n">anno</span> <span class="o">=</span> <span class="n">statebuilder</span><span class="o">.</span><span class="n">AnnotationLayerConfig</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;synapses&#39;</span><span class="p">,</span>
    <span class="n">mapping_rules</span><span class="o">=</span><span class="n">statebuilder</span><span class="o">.</span><span class="n">PointMapper</span><span class="p">(</span><span class="n">point_column</span><span class="o">=</span><span class="s1">&#39;post_pt_position&#39;</span><span class="p">,</span> <span class="n">linked_segmentation_column</span><span class="o">=</span><span class="s1">&#39;post_pt_root_id&#39;</span><span class="p">),</span>
    <span class="n">tags</span><span class="o">=</span><span class="n">TAGS</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">sb</span> <span class="o">=</span> <span class="n">statebuilder</span><span class="o">.</span><span class="n">StateBuilder</span><span class="p">([</span><span class="n">img</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">anno</span><span class="p">],</span> <span class="n">client</span><span class="o">=</span><span class="n">caveclient</span><span class="p">)</span>

<span class="c1"># Generate JSON states for each Task. Here, we will just do one state per Task, and we will also get a representative point for convenience.</span>
<span class="n">syn_df</span> <span class="o">=</span> <span class="n">caveclient</span><span class="o">.</span><span class="n">materialize</span><span class="o">.</span><span class="n">synapse_query</span><span class="p">(</span><span class="n">pre_ids</span><span class="o">=</span><span class="n">root_ids</span><span class="p">)</span>
<span class="n">state_urls</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">rep_points</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">root_ids</span><span class="p">:</span>
    <span class="n">syns</span> <span class="o">=</span> <span class="n">syn_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;pre_pt_root_id==@rid&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">rep_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syns</span><span class="p">[</span><span class="s1">&#39;pre_pt_position&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">state_dict</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="n">render_state</span><span class="p">(</span><span class="n">syns</span><span class="p">,</span> <span class="n">return_as</span><span class="o">=</span><span class="s1">&#39;dict&#39;</span><span class="p">)</span>
    <span class="n">state_id</span> <span class="o">=</span> <span class="n">caveclient</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">upload_state_json</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
    <span class="n">state_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">caveclient</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">build_neuroglancer_url</span><span class="p">(</span><span class="n">state_id</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span> <span class="c1"># Carve off direct link to JSON file</span>
</code></pre></div>
<p>The resulting state urls will be something like:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="s1">&#39;https://global.daf-apis.com/nglstate/api/v1/5437284948115456&#39;</span><span class="p">,</span>
 <span class="s1">&#39;https://global.daf-apis.com/nglstate/api/v1/5465241561333760&#39;</span><span class="p">,</span>
 <span class="s1">&#39;https://global.daf-apis.com/nglstate/api/v1/5221012541014016&#39;</span><span class="p">]</span>
</code></pre></div>
<h4 id="create-and-submit-tasks">Create and submit tasks</h4>
<p>Now that we have tables made and a set of states, we can finally use cavenvq to submit them to Neuvue and CAVE.</p>
<p>First we make the Tasks:</p>
<div class="highlight"><pre><span></span><code><span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">rep_pt</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rep_points</span><span class="p">,</span> <span class="n">state_urls</span><span class="p">):</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">cavenvq</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span>
            <span class="n">states</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="n">representative_point</span><span class="o">=</span><span class="n">rep_pt</span><span class="p">,</span>
            <span class="n">annotation_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="n">nv_namespace</span><span class="p">},</span> <span class="c1"># Fill out the tag field of the task annotation for CAVE</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
<p>Next, we assemble them into a TaskList.
Here, we want to also define a broadcast mapping to generate a new set of annotations from the proofreading work.
Since this will just be a table with a <code>bound_tag</code> schema, we only need to set up <code>pt_position</code> and <code>tag</code> fields.</p>
<div class="highlight"><pre><span></span><code><span class="n">broadcast_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">broadcast_table</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;synapses&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;tag&quot;</span><span class="p">,</span> <span class="s2">&quot;limit_to&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">]},</span>
            <span class="s2">&quot;pt_position&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;point&quot;</span><span class="p">},</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">tasklist</span> <span class="o">=</span> <span class="n">cavenvq</span><span class="o">.</span><span class="n">TaskList</span><span class="p">(</span>
    <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span>
    <span class="n">cave_task_table</span><span class="o">=</span><span class="n">task_table</span><span class="p">,</span>
    <span class="n">namespace</span><span class="o">=</span><span class="n">nv_namespace</span><span class="p">,</span>
    <span class="n">broadcast_mapping</span><span class="o">=</span><span class="n">broadcast_mapping</span><span class="p">,</span>
    <span class="n">task_instructions</span><span class="o">=</span><span class="s2">&quot;Please assign the category of the postsynaptic targets of the synapses.&quot;</span><span class="p">,</span>
    <span class="n">initial_status</span><span class="o">=</span><span class="s2">&quot;given&quot;</span><span class="p">,</span>
    <span class="n">next_status</span><span class="o">=</span><span class="s2">&quot;completed&quot;</span><span class="p">,</span>
    <span class="n">author</span><span class="o">=</span><span class="s2">&quot;casey&quot;</span><span class="p">,</span>
    <span class="n">assignees</span><span class="o">=</span><span class="s2">&quot;casey&quot;</span><span class="p">,</span>
    <span class="n">new_tasks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<p>We can now submit the tasks to Neuvue and CAVE.</p>
<div class="highlight"><pre><span></span><code><span class="n">nvq_url</span> <span class="o">=</span> <span class="s1">&#39;https://queue.neuvue.io&#39;</span>
<span class="n">nv_client</span> <span class="o">=</span> <span class="n">NeuvueQueue</span><span class="p">(</span><span class="n">nvq_url</span><span class="p">)</span>

<span class="n">td</span> <span class="o">=</span> <span class="n">cavenvq</span><span class="o">.</span><span class="n">TaskPublisher</span><span class="p">(</span>
    <span class="n">caveclient</span><span class="o">=</span><span class="n">caveclient</span><span class="p">,</span>
    <span class="n">nv_client</span><span class="o">=</span><span class="n">nv_client</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">td</span><span class="o">.</span><span class="n">publish_tasks</span><span class="p">(</span><span class="n">tasklist</span><span class="p">)</span>
<span class="c1"># Or use td.dry_run(tasklist) to see what would happen without actually submitting the tasks</span>
</code></pre></div>
<p>It will also be convenient to save a config file to make it more convenient to check the queue later.</p>
<div class="highlight"><pre><span></span><code><span class="n">td</span><span class="o">.</span><span class="n">save_task_config</span><span class="p">(</span><span class="n">tasklist</span><span class="p">,</span> <span class="s1">&#39;synapse_task_config.toml&#39;</span><span class="p">)</span>
</code></pre></div>
<h4 id="checking-the-queue">Checking the queue</h4>
<p>At this point, the assigned proofreaders can go to the Neuvue web interface and start proofreading.
We will now want to check the status of tasks and update the CAVE tables with the results when they are finished.
Our job is now very easy and it should be automated if everything goes well.</p>
<p>The verbose version of this would take all of the parameters we set above.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">cavenvq</span>
<span class="kn">from</span> <span class="nn">neuvueclient</span> <span class="kn">import</span> <span class="n">NeuvueQueue</span>
<span class="kn">from</span> <span class="nn">caveclient</span> <span class="kn">import</span> <span class="n">CAVEclient</span>

<span class="n">datastack</span> <span class="o">=</span> <span class="s1">&#39;minnie65_phase3_v1&#39;</span>
<span class="n">caveclient</span> <span class="o">=</span> <span class="n">CAVEclient</span><span class="p">(</span><span class="n">datastack</span><span class="p">)</span>

<span class="n">nvq_url</span> <span class="o">=</span> <span class="s1">&#39;https://queue.neuvue.io&#39;</span>
<span class="n">nv_client</span> <span class="o">=</span> <span class="n">NeuvueQueue</span><span class="p">(</span><span class="n">nvq_url</span><span class="p">)</span>
<span class="n">nv_namespace</span> <span class="o">=</span> <span class="s1">&#39;cavenvq_test&#39;</span>

<span class="n">qr</span> <span class="o">=</span> <span class="n">cavenvq</span><span class="o">.</span><span class="n">QueueReader</span><span class="p">(</span>
    <span class="n">caveclient</span><span class="o">=</span><span class="n">caveclient</span><span class="p">,</span>
    <span class="n">nv_client</span><span class="o">=</span><span class="n">nv_client</span><span class="p">,</span>
    <span class="n">nv_namespace</span><span class="o">=</span><span class="n">nv_namespace</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<p>Alternatively, we can just load the config file we saved earlier.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">cavenvq</span>
<span class="n">qr</span> <span class="o">=</span> <span class="n">cavenvq</span><span class="o">.</span><span class="n">QueueReader</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="s1">&#39;synapse_task_config.toml&#39;</span><span class="p">)</span>
</code></pre></div>
<p>And then to check the status of tasks and update the CAVE tables:</p>
<div class="highlight"><pre><span></span><code><span class="n">qr</span><span class="o">.</span><span class="n">run_update</span><span class="p">()</span>
<span class="c1"># To see what would happen without actually updating the tables, we can run `qr.run_update(dry_run=True)` instead</span>
</code></pre></div>
<p>Alternatively, a command line interface can do the same thing if you specify a config file.
Note that you will have to make sure that any computer you are running this on has similar CAVE and Neuvue permissions set up as you did when the tasks were created.
In your shell, run the <code>update_nvq.py</code> script with the config file as an argument.
Dry run mode is an optional argument <code>-d</code> or <code>--dry-run</code>.</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>update_nvqueue.py<span class="w"> </span>-c<span class="w"> </span>synapse_task_config.toml
</code></pre></div>
<p>This will update anything in the namespace, not only those cells in the TaskList we had made.
Becuase every Neuvue subtask has sufficient information to update CAVE tables, we don't need to specify the TaskList again.</p>
<p>To check the status of the tasks, we can use the <code>qr.get_task_data()</code> to get a DataFrame of the all Neuvue tasks and their status.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href=".." class="md-footer__link md-footer__link--prev" aria-label="Previous: About">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                About
              </div>
            </div>
          </a>
        
        
          
          <a href="../reference/reference/" class="md-footer__link md-footer__link--next" aria-label="Next: API Reference">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                API Reference
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.indexes", "navigation.instant", "navigation.footer", "navigation.prune", "navigation.tabs", "navigation.tabs.sticky", "toc.follow", "toc.integrate", "navigation.top", "search.suggest", "search.highlight", "search.share", "content.code.copy"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.af256bd8.min.js"></script>
      
    
  </body>
</html>